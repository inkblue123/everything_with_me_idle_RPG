# 战斗系统相关设定和系统

## 血量系统

血量是两段
0-50%是重伤，50%-100%是正常血量（轻伤）
轻伤阶段
轻伤血量会恢复
获得 10%的攻击、攻速、闪避、表层精力恢复速度，移动速度奖励

重伤阶段
血量会不断流失
获得-50%的攻击、攻速、闪避、表层精力恢复速度，移动速度惩罚
获得 30%的精准、暴击率、暴击伤害奖励
恢复物品对轻伤重伤的回血效率不一样

## 精力系统

精力是有两层的
表层是随便用随便回的，深层是只能休息回复的
表层精力最多只能回复到深层精力的比例上限
默认在休息时正常恢复表层精力和深层精力，
不处于休息时以 50%的速度恢复表层精力，不恢复深层精力
战斗工作时都不恢复

每消耗一定量的表层精力，深层精力就会扣一定数值

表层精力 0-25%是极度疲劳，25-50%是疲劳，50-100%是正常
疲劳时对全战斗属性都有 20%降低
极度疲劳时对全战斗属性 60%降低
深层精力通过限制表层精力来约束玩家行为

当表层精力的比例超过了 100%，就获得精力充沛效果，全属性 20%提升
有两个方向可以达到这个效果
比较廉价的是消耗品，直接加到表层精力上，那自然能超过 100%了
甚至在深层精力不足的时候都能强行顶起表层精力
不过这种情况下，表层精力用了就没了
比较耐用的是提高深层精力的 buff
深层精力变成了原本的 100%以上，那么表层精力自然也能恢复到 100%以上
而且在这种时候，只要额外的深层精力还没用完，表层精力每次都能恢复到 100%以上
可以多次享受到精力充沛

## 魔力系统

在一二三章节没有特殊设计，就只是一种会恢复的资源
少量的主动技能消耗魔力施展，稀少的技能可以提供魔力
主要的魔力提升途径是获得武器装备的器魂，吃掉之后可以提供一些

在第四章，城主给了玩家特殊功法之后，修炼这个就可以提高魔力的等级
此时魔力引入等级这个参数
等级就相当于魔力的质量，虽然不改变魔力的上限，但是原本的魔力会更耐用，而且施展的技能效果会更好

魔力等级也可以作为修炼某些技能的门槛，上限不足就不给加经验

魔力等级高了，原本的魔力恢复数值会打折扣，所以高级魔力恢复技能也开始出现了

魔力等级提高的具体实现方法
魔力等级提高的技能书会写明，这个技能可以对 n 点魔力提升等级，最高提升到 m 级
假如玩家有 100 魔力，技能允许提供 40 点 2 级魔力，那么练完之后，玩家就拥有了 60 点 1 级魔力，40 点 2 级魔力
恢复时从低级魔力开始恢复，使用时？？高低先用好像都有说法，
要是战斗规划系统能设置的很细致的话，就允许玩家自己选吧，默认也先用低级魔力

## 战斗伤害设定

游戏基本战斗方式分为近战远程魔法，三种方式细分成 3 种伤害
近战主要针对近距离敌人，一般基于玩家的力量属性，使用武器直接攻击敌人，主要对敌人造成“近战伤害”
远程主要针对远距离敌人，基于玩家的敏捷属性，远程武器需要消耗物品（比如箭矢）然后才能攻击，主要对敌人造成“远程伤害”
魔法主要针对中距离敌人，基于玩家的智力属性，魔法武器需要消耗玩家的魔力才能攻击，主要对敌人造成魔法伤害

造成的伤害类型主要基于当次攻击使用的技能
然后额外附加上武器的特殊效果

比如任何的近战远程魔法武器，都能使用“近距离挥舞”技能，
这个“近距离挥舞”技能的效果就是造成近战伤害，于是使用三种武器就都只造成了近战伤害
假如有个远程武器，它有被动，可以让攻击额外附加远程伤害，那同样进行了近距离挥舞之后，造成的就是
技能提供的近战伤害+武器提供的远程伤害，两段伤害

武器只提供属性，最终造成伤害的还是技能
而技能有各种使用前提，基本上能造成近战伤害的技能，就只允许手里使用的是近战类型的武器

伤害除了大分类为近战远程魔法以外，还带有属性，属性由武器提供
锋利属性，打击属性，未来可能的金木水火土属性，什么毒属性燃烧属性之类的

近战伤害有个小分类，锐器伤害和钝器伤害，这是由武器提供的，都归属于近战伤害
比如使用剑，它属于锐器，就有一个被动“让攻击变为锋利属性”，然后使用了“近距离挥舞”技能之后，近战伤害获得了锋利属性上

远程武器也类似，由于远程伤害相关的技能一般有两个条件，使用某种远程武器（比如弓），消耗弹药（比如箭矢）
其中就有两个变量，远程武器的锐钝，弹药的锐钝，
这里最终也由技能来决定，一般远程技能设定为，基于弹药的属性来改变最终的属性
“近距离挥舞”技能，不需要消耗弹药，效果是造成近战伤害，那远程武器（比如弓）的锐钝属性就能正常生效
“弓箭射击”技能，需要消耗弹药，效果是造成远程伤害，那就基于弹药的锐钝属性来改变最终的属性，弓的属性就不生效了

对于武器的被动提供的额外伤害，也应该定义好属性，最好不要出现无属性的伤害

对于跨类型的武器设定
假如设计了一个魔法剑，希望它遵守剑相关的被动技能和使用逻辑，仅仅在战斗时造成魔法伤害
按照刚刚的设定，就应该是创造一种新的近战武器类型，独立于剑、斧、匕首之类，名叫“魔法剑” --容易
然后设计限定条件为这类武器的新技能，新技能伤害类型设定成魔法 --容易
扩宽部分被动技能的适用条件， --困难
如果不想设计一个新类型，仅仅是设计一个彩蛋武器呢
那这把武器就是普通的剑
为这个武器设定专属的技能
这样实现起来就很简单，毕竟只是小需求
如果类似的武器多到一定程度了，再考虑转正吧

## 武器合成设定

在第二章开放村内村外设施之后，在铁匠铺进行
武器品质分白绿蓝紫红，普通，优质，稀有，史诗，传说
第二章的各种副本一般掉落白绿，极少情况掉蓝
村里的铁匠铺允许一样的多个白合成到绿，不改装备性质，只增幅一些属性参数
或者类似主动技能的设计，同种武器设计好最强形态，低品质就是锁了一些词条
因为是第一个铁匠铺，只允许合成到绿，第三章到城镇里的铁匠铺可以合成到蓝
再往后设计个什么牛逼匠人允许合成到紫
学习铁匠技能自己打造不能超过师傅的水平

制式武器最多只能合成到紫，
特制武器虽然能合成到红，但是设定红色传说级别的武器同世只有一把
历史上因为有传说，所以多半还在世界上，所以玩家能打造合成的也是紫色，
只有在某些事件或者副本里，才能遇到传说级别的武器，之后直接给或者被破坏允许玩家合成都可以

设定 10 把低级武器合成一个高品质武器，在另一个灵魂方面的 npc 处可以用 10 把史诗武器或者 1 把传说武器消耗掉，变成器魂
这样制式武器和特制武器都用传说级的消耗获得了器魂
拥有器魂相当于点亮了对应武器的图鉴，可以获得灵魂属性的奖励，
也可以无条件使用这把武器，相当于不占背包了
通过这种方式可以把武器装备带到幽冥地域去，毕竟都是灵魂

## 武器装备类别设定

武器分为近战远程魔法
近战武器
锐器
匕首，剑，斧头，长枪
钝器
空手或者拳套，棍棒，大锤，鞭子
全部近战武器就这么 8 种就好

匕首和拳套是极近距离武器，攻速最快，攻击较低，有较高暴击率
剑和棍棒是普通近距离武器，攻速攻击暴击全部普通
斧头和大锤是普通近距离武器，攻速最慢，攻击最高，暴击率最低
长枪和鞭子是群攻武器，在近距离里能打到最远的距离，攻击普通，攻速慢，暴击率低

匕首，剑，棍棒，鞭子是单手武器，可以同时使用副手装备

长枪，大锤，拳套，斧头是双手武器，副手会被占据

远程武器
双手共持，弓
攻速正常，暴击率正常，伤害正常
使用箭矢，弹药比较廉价

双手共持，弩炮
攻速最慢，暴击率最低，伤害最高
使用弩箭，弹药比较贵

单手，手弩
攻速较慢，暴击率较高，伤害较低
允许放在副手位置，使用弩箭

双手共持，喷枪
攻速最快，暴击率最低，伤害最低
属于 dot 攻击，使用一份弹药之后持续攻击几秒

单手，投掷
攻速正常，暴击率较低，伤害最低
使用消耗品，属于是垃圾桶类型了

单手，回旋镖
可以堆叠，单个攻速很慢，但是可以随着拥有的数量加快攻速
攻速较慢，暴击率较高，伤害正常
不消耗弹药，这种远程武器一般造价高昂

弹药的类别就随便定义了，基本上是全都有
箭矢可以有锋利和打击，弩箭也可以有锋利和打击

总共 6 个类型

魔法
施法核心（可以随意使用，基本相当于普通的武器）
法杖，魔法书，水晶，名字无所谓

阵法核心（也是一种武器，开始战斗之后数值逐渐增加，一定时间内加到最大）

扩散核心（额外消耗更多的魔力，更慢的施法速度，让法术变成大范围 aoe）

法术核心（相当于魔法版本的弓，施展魔法时要消耗物品，而魔力消耗会比较少）

召唤核心（魔力消耗比较少，设定是用魔力操控手里的这个特殊的魔力武器，借由这个武器去造成伤害，
那么相关的技能就是近战伤害类型的）

总共 5 个类型

## 武器增幅设定

武器上有最低使用属性限制，设定是武器有重量，或者使用有门槛，达不到的人连拿起都费力，或者用不懂
玩家低于这个限制时，不允许使用
武器还有最大使用属性限制，设定是武器本身不够坚硬，强行使用会破坏武器，所以主角会收着力使用
玩家属性高于这个限制时，会强行压到这个属性来战斗

在战斗中，只讨论武器的数值计算，基本上是玩家数值+武器装备数值=最终属性，用这个最终属性投入技能中，技能算出效果，打到敌人
对于近战，武器装备数值就是手上的武器的数值

对于远程，武器装备数值是远程武器面板+弹药面板的数值，打算武器占 6 弹药占 4，
所以单独来看，远程武器的面板会低于近战武器，不过低级远程武器允许搭载高级弹药，
在同一个地图里，玩家属性一致的情况下，远程的最大伤害会略高于近战
（武器是同一个等级的，远程可以不用常规最强弹药，而是用更稀有，更难获得的更高级弹药）
后期解锁投掷，允许空手施展远程，就是直接使用弹药
空手投掷时，远程武器面板就是 0，只加弹药面板
空手丢弹药基本上是不如使用同级别远程武器的，只是给究极后期玩家做一个保底的远程攻击手段

对于魔法，武器装备数值是魔法武器面板\*魔法武器倍率
倍率一般都在 100%左右，只针对几种属性，其他属性就很低
空手施法时，魔法武器面板为 0，魔法武器倍率为 100%，没有使用属性限制
单独来看，魔法武器的面板也会因为倍率而低于同级别近战武器
前期玩家只能用各种魔法武器，自身属性+武器属性乘以武器的倍率之后，再输入到技能里，放出魔法技能
中期魔法技能解放，允许空手施展魔法
这时，有些流派的技能可能是空手施展比较好，某流派用专门的魔法武器伤害比较高，没有好武器的话，玩家空手也能施展
后期因为魔法武器的使用数值限制，跟不上玩家的武器都淘汰了，许多情况下就是空手施展魔法技能，
只有一些神器，数值足够高，才能承载玩家的属性，同时仅仅释放出 110%的倍率就足够强，比空手释放强就行了
只要用“使用数值”来控制，后期的武器倍率不会越来越膨胀，因为玩家没有其他选择

## 死亡设定

主要是给死亡多加个剧情设定
平时自动存档，在旅行出门时存了之后旅行过程中就不存了

死亡之后进入“幽冥地域”，可以设定一个神什么的，巴拉巴拉介绍你是很特别的人
然后允许你返回
选择自动存档复活就是说“带着前世记忆复活，这一世我要赢回所有”

幽冥地域也是一个安全区，也可以旅行出去找事，可以获得技能可以练级
但是获得的物品不能带回阳间，主要是可以练一些在阳间比较难练的技能
感觉就像是一个针对灵魂层次的练功房

未来还可以加入物资共享的机制，让地府真的变成一块新地图（DLC）

## 玩家攻击的设定

玩家的战斗是通过“主动技能”来进行的
玩家身上有主动技能槽，然后往里面放入主动技能，
开始战斗之后，时间运行，遍历每个槽位，激活槽位里的主动技能，技能产生各种效果
遍历完毕之后，一回合结束，再反复遍历，实现自动的长久的战斗

细节设定：

玩家开始只有 3 个槽，后面逐渐解锁，最多拥有 9 个槽

遍历一个槽需要的时间是攻速，

一个主动技能可能会占据多个槽
比如表示轻攻击的主动技能只占据一个槽，那么玩家一开始就可以塞三个轻攻击，一回合打 3 次
表示重攻击的主动技能占 2 个槽，那开局 3 槽就只能放一个重攻击，另一个空着的槽就放不进第二个了
虽然一个动作占据了两个槽，但是并不一定就纯削弱，而是可以绑定两个动作在里面
比如两个槽的前一个是攻击，后一个叫攻击后摇
使用远程武器时，前一个是拉弓，后一个是攻击，
如果想削弱某个主动技能，那么给要求这个技能占据更多的槽，或者绑定的动作里加没用的占位动作，就能削弱
如果想设计某一流派的一连串招式，那么就给相关的技能要求占据很多槽，然后里面每个位置都和对应流派相关

主动技能有各种各样的限制条件，
简单的限制，比如必须手持近战武器，比如需要用蓝，
更高级的限制，比如需要在血量高于一定数值时，比如必须放在第一个槽位里
如果不满足条件，时间走到这个槽里的时候就什么都不做，相当于空着了

技能和技能之间的连携
除了依靠两个技能的效果，由玩家主动组合在一起发挥更大的作用以外
两个技能之间还允许写明条件，当某某技能在主动技能槽时获得加强
这种方式也能充当流派设计的一部分

## 战斗中的距离因素

整个战斗场地的距离总共是 300，
0-100 是近距离，101-200 是中距离，201-300 是远距离
每个距离中有 9 个格子，前 3 个格子距离是 0-30，中是 31-60，后是 61-100

玩家和敌人之间有距离这个参数
玩家每一次攻击速度持续时间结束，会先进行一次移动
移动的距离最多根据玩家的移动速度属性，可以向前或者向后移动
移动完成之后进行攻击，会有一个攻击范围的概念
攻击范围大致像一个同心圆，在圆心附近距离属于主要攻击范围
敌人位于主要攻击范围内时，伤害精准等等属性正常计算
距离圆心较远的位置，属于次要攻击范围
敌人过近或者过远，位于次要攻击范围内时，攻击造成的各个数据都会降低，主要是命中率急剧降低
距离圆心更远的位置，属于无效攻击范围
敌人在无效攻击范围时，完全不会收到伤害

攻击范围的宽度和划定位置取决于武器类型
比如匕首，设定上就是极短距离的近战武器，
那么它的主要攻击范围就在 0-10 的距离里
然后设定次要攻击范围的距离是 0，就是说 15 距离的敌人就打不中了
或者设定次要攻击范围是 10，这样在 10-20 距离的敌人就会收到些许匕首剑气的攻击，但是伤害比较低
再比如长柄武器和鞭子，设定上是近战武器中打的最远的
它们的主要攻击范围设定到 70-90，次要攻击范围是 10
那么 0-60 的敌人打不中，60-70 的敌人受到少量伤害，70-90 的敌人正常受伤，90-100 的敌人少量受伤

然后再对次要攻击范围做细化，分为近-次要攻击范围，远-次要攻击范围
功能不变，只是对两边次要距离做细化设定，
比如远程武器，弓，设定主要距离在 201-230，近-次要距离范围为 100，远-次要范围为 0，
这样在攻击时，就算玩家移动能力不够和怪物拉开距离，也能当敌人从远距离到中距离移动过来的过程中尝试射几次
如果玩家移动能力出众，那完全可以实现远程风筝敌人的战术
比如喷枪，设定是中近距离，主要范围 50-150，次要范围两个都是 0

除了武器类型的规定，玩家主动技能也可以设定范围
因为许多主动技能会规定手上应当使用的武器，也就是说，这些技能默认就和武器的范围一致
可以在此基础上修改范围，但要做好限定条件
限定范围很宽的技能，根据技能想要产生的效果来修改范围
比如全近战通用的技能，如果技能约束了范围，那么对匕首和对鞭子就有不一样的效果，此时就应该不约束范围，使用武器的默认范围
比如给全武器的保底技能：近距离挥舞，那远程武器也要用，魔法武器也要用，就不能用武器默认范围，得使用技能规定的范围
另外还有复合类型武器，由于同时归属于多种类型，攻击范围初步设想是多种武器类型范围的并集
这样从设定上看挺合理的，可能在游戏性上会不好控制，需要注意
避免设计设定上范围比较冲突的复合武器，避免点炒饭
更完善的想法是在放技能的时候知道选用了哪个武器类型，然后就适用对应武器类型的范围

敌人刷新时会随机选择距离，然后刷到对应距离的空格子中
之后每回合也先移动，然后攻击
由于格子和距离相关联，如果有 3 个敌人移动到了近身 0-29 的范围内时，格子都占满了，后面第四个敌人就没法再向前了
同理，如果中三个格子都占满了，前面的敌人也没法主动后退
敌人的攻击也有范围的概念，但是没有次要范围了，
当玩家不在敌人的攻击范围内时，敌人这一回合会先移动一次，
如果玩家在范围了，那就攻击，然后进入下一回合
如果还不在，那就不攻击了，并且再移动一次
当玩家在敌人攻击范围内时，敌人这回合就攻击，然后移动一次
敌人的移动趋向于将玩家的距离移动到自己攻击范围的中间

有些敌人不止会普攻，它还会使用技能，此时有两种情况

拥有技能的普通敌人，攻击时用不用技能的逻辑是随机选择，如果选到了技能就用技能
这个技能的范围可能和普攻的范围不一样
如果敌人要用技能，而且玩家不在范围内，那一样会移动两次，
但是因为技能没放出去，所以下一回合敌人依旧会使用这个技能

拥有技能的精英敌人或者 boss，攻击时会更智能
如果身上有数个技能，范围不一，会主动选择当前能打中的技能
可能在读条的时候玩家离开了范围，然后就和普通敌人一样，先移动一次，再攻击，
或者移动一次之后依旧不在范围，那就移动第二次，然后中断当前技能，进入新的回合
新的回合又根据当前距离重新选择技能，

在某些情况下，boss 会更狠，
比如选择了技能，移动一次之后依旧不在范围
或者都没有移动，读条完了发现玩家离开了范围
就提示敌人强行变招，改成另一个范围能打到玩家的技能，立刻施展
为了平衡，可以说敌人强行变招收到了反噬，自己掉一些血量
然后变的技能不能是更强的，不能变成特殊连段技能
低于一定血量不再变招

## 战斗和存档读档

玩家如果在一个战斗地点里存档，读档时大约会有一些情况需要处理
符合玩家直觉的存档情况是把当前战斗地点里的状态都存下来，比如当前刷怪数量，当前地点里的怪物数量、位置、血量等情况
读档之后这些信息也都保持一致
但是这样做从代码实现上来说有点麻烦（懒）

符合代码实现的方便来说，只要在存档时保留当前地点 id 就好，读档时做一些处理

比如玩家在普通的战斗场地内，存档时仅保留当前地点 id，读档时调用地点类的进入地点函数
相当于重新进入了战斗场地

如果玩家在有门槛的战斗场地内存档，读档时也应该还呆在这个场地里，而且这次读档重新进入地点不能再收门槛

如果存的地点 id 是限定次数的，那读档时重新进入也不消耗次数

如果存的地点里的怪是很珍贵的，正常游戏进去打一个少一个，那读档也应该记下来，防止存档读档就让玩家刷到

综上，最好的操作还是符合玩家直觉的做法，代码上麻烦就麻烦了吧
但也还是可以偷点懒
存档时不需要保存每个怪的攻击状态，而是让怪执行一次普通攻击，并且随机这次攻击的进度（这样就好像继承了存档时的状态）
如果不设置普通攻击，刷出来的怪一起读条会穿帮
那为什么不保存攻击状态呢（）
还是别偷懒了
