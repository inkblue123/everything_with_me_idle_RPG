# 程序开发小巧思

## 通用数据结构幻想

所有战斗都在某个场景

场景存了 n 个怪物编号，n 个场景效果
怪物登场有条件，比如同场怪物数量上限，当前时间、、

为了通用或许也不一定要把场景和怪物参数绑定
这个信息可以做成固定游戏数据，
副本 A 中存储场景信息，怪物信息，掉落物信息，通关后事件编号

副本 A 本身只是一个结构体，是通过这个结构体内部的参数来生成战斗区域和相关内容的

## 为想新技能和写程序的偷懒的设想

技能分被动和主动，之前设想的主要是被动
对于每个主动技能，有着基本的几个要素

-   限制条件
    技能的限制条件有两部分，
    一部分是激活条件，比如在一次攻击间隔结束时才能激活、攻击间隔内持续激活、概率激活、绑定在装备上、某某状态下允许使用、血量高于一定程度、敌人处于攻击范围内等等
    满足了这些条件，这一帧游戏运行的时候，才允许执行这个技能
    另一部分是技能的代价
    使用主动技能之后，消耗某某资源，比如精力，蓝，血，或者背包物品，
    或者技能期间持续消耗，
    或者技能结束之后再支付

-   技能效果的基础
    基于玩家某某属性，计算出主动技能生效之后的具体效果，比如造成的伤害值，增加的防御，
    一般来说主动技能初始是基于一个属性的，也可以基于多个属性，基于红绿蓝资源，基于某被动技能等级
    这块在实际运用中分两部分，玩家基础和补正
    玩家自带有攻击力属性，总不能说某个技能基于力量造成伤害，就无视了攻击力属性吧
    所以玩家基础部分不受技能影响，就算技能没有设置，也该用上
    然后是补正，就是基于玩家属性额外再加成了

-   技能的具体效果
    一般是和技能本身绑定的，就是各个技能各不相同，不然就变成换皮了
    但是有些大类的技能还是不可避免的很相似，
    比如攻击类型的技能，无非就是物理或者魔法或者元素（如果有的话）
    打击近距离|中距离|远距离，或者都打
    打 1 打 n
    造成 1 次伤害，造成 n 次伤害
    辅助类型的，给自己的有临时加成面板属性，临时恢复资源，获得某某 buff
    给敌人的就反过来削弱

一个技能大概就是由激活条件、代价、效果基础、具体效果组成的
为了往游戏里塞更多的技能，想法是让每个技能可以“升级”
比如设计火球术 A，火球术 B，火球术 C
学完都是可以习得火球术这个技能（激活条件共用）
但是对于 A，使用需要消耗 1 蓝，B 需要用 1 个火球符文，C 需要处于 80%精力以上允许使用（多种使用代价）
A 基于灵魂属性造成伤害，B 基于技巧属性造成伤害，C 基于精力属性造成伤害（不同的效果基础，同也没关系，可以增加倍率）
A 对中距离敌人造成伤害，B 对近距离敌人造成高伤害，C 对近距离敌人造成两次伤害

那么如果真的这么设计三个火球技能，这就很换皮，不够有意思，后期也用不到这块代码了，挺浪费的
不如设计一个火球技能，把刚刚提到的要素全都融合进去，根据学到的不同技能，解锁对应的要素

比如开始只学到了 A，那就是一个普通的火球
后来学到了 B，原本的火球就升级了，可以同时基于两种属性来造成伤害，可以同时攻击中近距离敌人，还可以在没蓝的时候使用火球符文代替消耗
再后面学到了 C，又变得更强

技能在一开始设计的时候就设计最强的状态，给玩家用的是加了很多个限制条件的版本
重复学习的过程就是解开各个限制的过程，这个学习顺序可以随意调换，就是各个锁先后解开的区别而已
这样一个主动技能就可以拆成很多个技能书，玩家玩到的时候获取技能书的顺序不同，玩到的感觉也不一样

在这个基础上换皮就高效多了（）
小火球，大火球，巨大火球，只要最终版本的差别大一些，基础版本相似也没关系，
玩家会在变强的过程中使用喜欢的那一种，而且可能后面小火球还比巨大火球更强，再又随着游戏进展而变化

代码会不会很复杂（）
代码真的很复杂（）
至少数值很难设计

想出来的代码实现方案：
最开始设计基础版本
然后设计 n 个它的解锁后的加成
玩家身上存储这个技能的解锁情况
玩家身上存储这个技能解锁之后的汇总详细参数

比如小火球 ABC
开始设计一个小火球，id=little_fire
设计它的基础版本，P_skill["little_fire"]
这里设计了最基础的限制条件，属性补正，索敌逻辑等等（这里可以全填 0）
然后设计小火球 A 解锁加成，id=little_fire_A
base_skill["little_fire_A"]
这里设计了，限制条件需要 1 蓝，基于灵魂属性的属性补正，索敌逻辑是中距离敌人造成伤害
以此类推设计火球 B 和火球 C

然后玩家获得了火球 A 的时候
先检测玩家有无火球，当前是无，所以获取基础版本
然后读取 A 的加成参数，在基础版本上叠加这些参数
这样玩家就拥有了一个基础+A 的技能，呈现出来的效果就是火球 A
当玩家获得火球 B 的时候
读取玩家有无火球，当前有，跳过基础版本获取
然后读取 B 的加成参数，在目前的数据上叠加 B 的参数
这样就得到了 AB 火球

ABC 的获取顺序轮换都行

## buff 系统

### 问题 1：key 的定义

初步设想，是存放在玩家属性对象中的各个对象，每个对象有 id，有时间，有效果
实时更新，删除过期的 buff 对象，添加新对象等等

开发过程中，发现 buff 似乎有点不那么常规
简单来说，如果有两个食物，效果都是通过 buff 回血，食物 A 回血量比较多，那么作为玩家的常规想法，吃掉这俩食物之后有这么几种情况
1：获得两个 buff，分别叫食物 A 和食物 B，buff 同时存在，回血量是两个 buff 的叠加
2：获得食物 A 代表的回血 buff，再因为使用食物 B 获得同样的回血 buff，后一个 buff 覆盖了前一个 buff 的时间和效果等等参数，相当于仅吃了食物 B
3：获得食物 A 代表的回血 buff，吃食物 B 时系统判断这个回血 buff 效果比较弱，就不会覆盖，所以食物 B 没有任何效果

这里选择第一个方案，让玩家利益最大化

### 问题 2：新旧 buff 兼容

然后开发的时候有个情况，如果遇到同 id 的 buff，应该怎么处理
旧 buff 一般是运行了一段时间了，剩余时间较短，新 buff 还是完整的时间
新旧 buff 的效果可能不一样，
如果 buff 一样，就用时间更长的 buff 的时间
如果时间一样，就用 buff 效果更强的效果

纠结的地方在于新 buff 效果更强，但是时间更短应该怎么办，以及反过来，新 buff 效果较弱，但是时间更长

比较通用的解法是不再让程序判断玩家的利益，直接让新 buff 取代旧 buff
开始还想有点小巧思，结果实现不来，算了

### 问题 3：复合属性 buff

开发时遇到了新问题，如果有一个很强的 buff，同时给予了多种属性，那应该怎么开发
目前根据 buff 系统的情况，所有 buff 根据它的时间依据分成了几类
最复杂的情况，这个 buff 同时提供属性加成，提供回血和回精，生效 10 秒/生效 5 回合
想了一下，多复杂的 buff，它的生效时间是对整个 buff 而言的，不应该设计同一个 buff 有几个生效时间
那么复杂的部分就是属性了

1：这一个 buff 就是会提供多种属性
2：这个 buff 实际上是同时给予了多个单一 buff（灵感来自于玩家主动技能）

2 号方案比较难搞的应该是 buff 的 id 问题
当玩家获得了一个 buff，就会在 buff 总对象中添加一个键值对，key 是 buff 的 id
如果使用 2 号方案，就会在 buff 总对象中添加很多个键值对，存放各个子 buffid
而且这些子 buffid 之间完全不能重复，不仅是复杂 buff 内部的子 buffid 不重复，更是不同复杂 buff 内部的子 buffid 都不能重复
否则会出现复杂 buffA 给予了子 buff abcde，复杂 buffB，给予了子 buff afghi
由于出现了同一个 a，在更新和删除时会出现意外情况
所以应该用方案 1

### 问题 4：重复的单一属性 buff 生效与消失

假如有几个不同的 buff，都有同一个效果，比如加成攻击力，那显然应该叠加
乘算的乘算，加算的加算，总之按照一个规矩来
中间有新 buff 就重新计算，更新到玩家属性上，有 buff 消失了，也重新计算

但是如果这个效果，是 bool 类型的，那按理来说，也应该叠加
那么某个 buff 消失了，这个 bool 是还原呢，还是保持呢，
虽然按照常识很好处理，只要有 buff 生效，无论一个两个，无论是哪个生效，bool 都应该是 true，但是到程序里就相对有点复杂
因为 buff 消失的时候，这种效果需要“还原”，不然就永远修改了
这个还原操作有时候就可能错误的还原了其他对同一个效果生效的 buff
比方说
有两个敌人，一个会给玩家上睡眠 buff1，另一个会给玩家上睡眠 buff2，两个 buff 的内部都有一个效果“进入休息状态”，两个 buff 时间不一样
玩家先得到睡眠 buff1，根据内部的效果，将休息状态设置成了 true，然后等 buff1 消失
在 buff1 还没消失的时候，得到了睡眠 buff2，按照目前的逻辑，就也会将休息状态设置成 true，然后等 buff2 消失
之后 buff1 消失，由于需要清除这个 buff 的效果，就把休息状态设置成了初始值 false，
但此时 buff2 还没消失呢，玩家却动了，这就和表现不一样，是 bug 了

总之，在每一帧实时更新 buff 的时候，应该将所有 buff 具体情况，和总体 buff 效果分开处理
每一帧获取所有 buff 的各种效果，累加到一个总对象里
之后把这个总对象里的信息去改变游戏数据

如果 buff 变动，就从总对象里针对这条 buff 相关效果进行更新
之后再把总对象里的信息去修改游戏数据

为了能兼顾各种类型的属性累加，规定 buff 的效果，尽量都变成加减算数字，尽量别做将数值改变成某某数的效果
bool 类型变成初始值为 0，有一个效果将其置 true，那就是在总对象里给这个属性数值+1，总对象更新时将数字转换成 bool 去更新
这样在 buff 消失的时候，清除效果就变成减去原本加的数值，就能恢复

这个设计思路可能还会用到其他地方，这个总对象的机制可以处理好 buff 系统内部的各种变化，得到总结果，那常用的各种全局效果，是否也面临着多种可能的东西进行修改呢
得益于 js 是单线程的，这些逻辑还算是可以理解和处理，尽量避免吧

### 问题 5：buff 属性展示，buff 的提示窗机制

所有 buff 安排在左上的玩家属性界面里，开了一个空间专门放 buff，生效的所有 buff 都放在这里
现在需要给这里的 buff 加上鼠标移动过去显示详情的功能
问题在于，buff 是会动的，有些 buff 时间到了会消失，之后它后面的 buff 就向前移动，鼠标的显示就会需要更新
并且由于鼠标要看，就不能用清空的方式修改这个界面里的内容，不然每帧都清屏，鼠标显示功能也会受到影响

目前的解决方案是打算将 buff 按时间排序，无限时间的 buff 放最左，有限时间 buff 按时间从大到小排列，这样 buff 在消失的时候，就始终是最后的 buff 会消失，不会影响到整个布局的其他元素
但是这种情况下，新增的 buff 会插入到队列里，那插入就插入吧
发生 buff 个数种类变化的时候，所有 buff 都会重新刷新，影响鼠标的提示框就影响算了

时间计时的 buff 和回合计时式的 buff 应该分开，当然，在遍历所有 buff 的时候就是分开的

这个方案有个情况，就是频繁刷新的 buff
假如某个地点有场地效果，实现的逻辑是给予玩家 debuff，再假如玩家有个驱散效果，可以无视这个 debuff 的效果，那么这俩就不能是前一帧赋予 debuff，下一帧清除 debuff，再下一帧赋予 debuff
这两个效果应该都是 buff，同时存在，只不过在处理 buff 效果时跳过 debuff 的处理

## 敌人数据库

一个战斗区域里要有几种怪物随机刷新，最简单的例子就是一个高攻低血低防，一个普通，一个低攻高血高防，三个怪随机出现，给玩家一点不同的体验

想要做的更好，那就安排更多种类的怪，十种就是相当多的了
但是细究起来，里面可能有些 boss 怪、宝箱怪、十分少见的稀有怪，白天才刷新的或者晚上才刷新的条件怪
具体到玩的时候，可能还是只有三五种怪当作小兵
不过这已经是比第一层设计要好的了，是普通的正常设计

再想做的更好，那么就要在第二层的基础上，让日常也刷更多怪
但是它们都是小兵，既然在这一个区域里刷新出来，属性就大同小异，并且掉落物也大同小异，甚至都是那么几种，毕竟不能掉落其他地图的东西嘛，假如真的掉了很多不同的掉落物，那除非游戏的物品系统很丰富，否则大量掉落物会影响平衡，只能是掉大量的垃圾，那么影响游戏体验，不如不掉。
那么这个时候，多种小兵在数据库里实际上就只是换了个 id，换了个名字罢了

此时，巧思来了，给最基础的三种怪安排一个“随机名称”的设定，刷怪时随机给个名字，不就很简单的做到了感觉上很多种怪？

这个做法有个问题是图鉴不知道怎么开发
按理来说怪物图鉴就是一个 id 开一条，描述它的情况
如果加入了随机名称，那么随机名称的这种怪，应该怎么设定图鉴呢
1：修改图鉴的逻辑，不按 id 排列，按玩家能看到的随机名称排列
这个方法的问题是排序
多个名字不同属性一样的怪很难避免的并列在一起，看起来就让人觉得，这个游戏作者好敷衍
需要再额外开发一个随机排列功能

2：图鉴依旧按 id 排列，随机名称设定时就和主名称起的差不多，在图鉴里写明随机名称的设定
比如主名称是野猪，那么随机名称就是老野猪胖野猪之类的
图鉴里以野猪开一条图鉴，直说老野猪胖野猪都遵守这个图鉴
这个方法有个问题是并没有很好的起到随机名称造出更多小兵的效果，
玩家都不用进图鉴，刷怪的时候就能直接发现，什么老野猪胖野猪，其实就都是野猪嘛
毕竟如果随机名称写的很乱，那么玩家一看图鉴，野猪的页面下怎么有蛇有树精有牛，看着更怪

随机名称和真正在数据库里新增一个同属性 id 的设计上，还有一个天然的问题
那就是这些随机名称的怪，就真的大同小异了
今天是想偷懒，做了随机名称，后面想用某个名字当作新怪，那还是得给他单开一个敌人对象
针对随机名称的怪属性一样的问题，也可以在刷怪时设定随机属性波动，掉落物也可以随机波动

随机名称这个想法的优点本来是相对于新增敌人拷贝可以少写代码
但是随机名称要做好，得同时有图鉴随机排列代码，初始化属性波动，初始化掉落物波动的代码
可能并没有省下多少
又但是，这个东西做出来以后，确实是可以在不想做新怪的时候偷懒

## 暴击算法

游戏中涉及到暴击的时候都是只提供一个概率，
如果用这个概率随机是否暴击，就会面临硬是不暴击或者连续暴击的情况
这在其他游戏里是常见的需要避免的情况
比如玩家打敌人，30%概率暴击，理论上两三刀暴击一次，但如果某个时候就是不暴击，就会让玩家感觉很怪，而这种情况又确实理论存在
或者被敌人连续几次暴击打死，也是理论存在的小概率事件，也会影响游戏体验

所以在这里，暴击的方案要进行修改
初始暴击概率为 0，每尝试一次，暴击概率增加 x，暴击时概率重置为 0

| 宏观暴击率 | 每次增加的 x |
| ---------- | ------------ |
| 5%         | 0.35%        |
| 10%        | 1.5%         |
| 15%        | 3%           |
| 20%        | 5.6%         |
| 25%        | 8.4%         |
| 30%        | 12%          |
| 35%        | 16%          |
| 40%        | 20%          |
| 45%        | 25%          |
| 50%        | 30%          |
| 55%        | 36%          |
| 60%        | 42%          |
| 65%        | 48%          |
| 70%        | 57%          |
| 75%        | 67%          |
| 80%        | 75%          |
| 85%        | 83%          |
| 90%        | 89%          |

由于正常定义在数据库里的概率和玩家看到的概率都是宏观暴击率，程序内使用的每次增加值需要根据宏观暴击率计算得到
所以宏观暴击率为 x，每次增加值为 y，函数符合
当 x 在 0-85 时
y=0.011x^{2}+0.05x
当 x 在 85-100 时
y=1.14x-13.7

所以执行一次 x 概率的暴击，实际上就是用 x 算出 y，然后根据尝试次数算出真暴击率，使用真暴击率数值随机一次得到暴击结果
其中有个问题，就是尝试次数的保存，有两个方案

方案 1：
将输入的 x 宏观暴击率取整，然后当作 key 进行存储
当暴击率变动时，程序就读另一个暴击率值里的尝试次数
总能给出一个结果来
取整有个问题，1%以内的数值要随机的话，尝试次数都会存到 key=1 的这个数字里，千分级别的数值随机就不对了

方案 2：
仿照保底机制，将尝试暴击的事件当作 key 存储
同一个事件的暴击率变动时，尝试次数不会变化

感觉方案 2 的 key 优点难取，主要是有点懒
两个方案都不会影响到玩家的体验，方案 1 通用些，就用 1 了

## 游戏物品分类

游戏中的各种物品，目前分为装备，消耗品，材料
目前只有装备类型的物品存在特别的参数，比如攻击防御之类的
可以预见，之后消耗品也有参数，比如吃掉之后回血数值
而材料，应该不会有特别的参数吧，只有基本的价值，堆叠数量

### 物品数据库的数据结构

目前的设计，是一个利用了 js 特点的混合类数据结构
最开始以为如果一个物品同时属于两个大类，那这个 item 数据库对象应该要有两个大类里的函数
后来发现，这些函数实际上只是为了方便填写对象参数的
实际游玩的时候，对物品对象仅仅取用对象参数，而不会用到对象的函数
所以考虑去掉不必要的混合类数据结构设计，回归其他数据库里一样的父类与子类数据结构

### 物品小类和分类时的应用

游戏中的物品需要分类，除了将所有物品分为三个大类以外，还需要更细致的分类
目前将装备按照装备小类进行设定，如剑，头盔，盾牌之类的
一个装备物品可能同时属于几个小类（少数特别的武器会这样设定）

按理来说，一个物品如果同时是装备，又同时是材料，应该同时拥有两个大类的各自的小类
那么一个物品就会有很多个小类，这带来了一些问题

由于小类会用到物品筛选和过滤，玩家身上有一堆东西时，可以用过滤功能，这样会筛出某一分类下的物品
这时候的分类理应不重复，一个物品仅能属于一个分类
那如果一个物品同时属于两个小类，分类时如何判定
比如一把木剑，后续可以进行升级，理论上应该属于材料
那么装备的分类会有木剑，材料的分类也有木剑，这就有点怪的

解决方案是将分类设定优先级，
由于装备和消耗品是明确不会重叠的两个大类，刚刚提到的问题其实就是材料属性不明确
如果一个物品是装备，那分类时就只显示它的大类是装备，只显示装备大类中的小类
无论它是否可以当作材料
消耗品同理

### 物品的材料标签

一个物品如果可以升级合成，那它是材料，需要让玩家知道它是材料的这个设计，来自于泰拉瑞亚
具体做法是标一个“材料”的标签
在我的游戏里，一个物品如果可以升级，在物品数据库的定义里是不知道的
合成相关信息存储在配方数据库里
想要实现这个效果，需要在数据库初始化完成之后遍历每个配方，将其中的原料物品的数据库设定“材料”标签

### 装备大类中的小类

归属于装备大类的物品，都是可以穿戴在玩家身上的
武器，防具，副手，饰品，工具
工具还没定义

具体的小类有这些：
// 近战武器
'dagger', //匕首
'sword', //剑
'battle_axe', //战斧
'long_handled', //长柄武器
'gloves', //拳套
'sticks', //棍棒
'hammers', //大锤
'whips', //鞭子
//远程武器
'bow', //弓
'crossbow', //弩炮
'hand_gun', //手弩
'spray_gun', //喷枪
'boomerang', //回旋武器
'throw', //投掷工具
//魔法武器
'putmagic_core', //施法核心
'zhenfa_core', //阵法核心
'magic_core', //法术核心
'spread_core', //扩散核心
'summon_core', //召唤核心
//防具
helmet//头盔
chest_armor//胸甲
leg_armor//腿甲
shoes//鞋子
//副手
shield//盾牌
//饰品
ornament//饰品

### 消耗品大类中的小类

如果物品可以点击即用，比如药品，食物，技能书之类的，应该算做消耗品
如果物品在战斗中使用了，比如箭矢，弹药，应该算作消耗品
如果物品在生活技能的探索采集类技能里消耗了，比如鱼饵，挖矿的炸药，考古的藏宝图，应该算作消耗品
如果物品在交易中使用，比如各种货币，应该算做消耗品
这些是属于消耗品的物品的特征

具体小类目前可以定义的有
食材，ingredient
可以点击即用，还可以制作成食品
一般会把它们吃了之后的属性设定成缓慢恢复血量精力魔力
重复吃食材会延长这个缓慢恢复 buff 的时间
食品，food
可以点击即用
由食材制成
吃了之后可以获得对应食材的所有缓慢恢复效果的累加
并且有新增的立刻恢复血量精力魔力
干制品，dry_product
可以点击即用
由较多的食材制成
吃了之后没有对应食材的缓慢恢复效果
只有新增的立即恢复效果
（精制调味料）,refined_seasoning
不能点击即用，所以就不是消耗品了，算作材料，在这里是摆一起比较好以后来查
由大量食材制成
在烹饪食品的时候加入，给食品加上该调味料的食材的缓慢恢复效果

药材,crude_drug
可以点击即用
吃了之后会直接降低一些血量精力魔力
获得攻击防御等等属性的一个增强 buff，这个 buff 的数值会缓慢降低
重复吃可以重置增强 buff
药水,potion
可以点击即用
由药材制成
去掉药材的扣属性效果
获得对应药材的增强 buff 的累加强化版本 buff
丹药,elixir
可以点击即用
由较多药材制成
去掉药材的扣属性效果
直接给予一定时间的属性 buff，不会降低的那种
（丹药精华），elixir_essence
不能点击即用，所以就不是消耗品了，算作材料，在这里是摆一起比较好以后来查
由丹药分解而成，一种丹药如果有多条效果，每条效果都会得到一种精华

箭矢,arrow
使用弓的时候消耗的弹药
弩箭,bolt
使用弩、手弩的时候消耗的弹药
喷枪弹药,spray_gun_bullet
使用喷枪的时候消耗的弹药
可投掷弹药,throwable
使用投掷工具的时候消耗的弹药
也可以点击即用，有一定时间 cd
法术核心弹药,magic_core_bullet
使用法术核心这种魔法武器的时候消耗的弹药

鱼饵,bait
钓鱼时可以选用消耗
给上钩阶段提供额外的上钩力加成

宝箱 treasure_chest
可以点击即用，随机获得宝箱内的物品
货币
交易时消耗

### 纯材料物品的小类

目前纯属材料的物品，还没有想好怎么设定它们的小类
有两个方案

1：根据现在已经设定了的物品来看，比较明确的是根据材料的系列进行分类
比如木，石，皮，骨这样的
这样是根据物品的名称和来源，从第一感觉上进行分类，
这个分类能符合玩家的直觉，但是不清楚能不能适用于所有物品

2：从物品在游戏里的主要获取来源进行分类
如主要是从自然界中获取的，分类为天然材料
主要是制造出来的，分类为人工材料
不能参与合成的分类为成品
这个分类的维度少，很简单粗暴，可以适用所有物品，但是对玩家来说不一定好用

3：从物品在游戏里主要从哪个技能获得进行分类
如木头相关的物品分类叫“for_logging”，来自伐木的物品
这个分类机制相当蠢，不可用，但是给物品添加一个来源标签却是可行的
鼠标移动到物品上的提示框里给一个来源技能标签，物品图鉴里给比较详细的来源

感觉得换成方案 1
不过方案 1 也有自己的问题

如果分类的维度较少，那么单一类型里就会有很多物品，横跨游戏早期和后期，
那么系列分类就只能做成分类，没有其他用处

如果分类的维度给的比较细，比如石头系列分成了“凡石”，“灵石”，“魔石”
单个分类里的物品就不多，可以在某些配方里设定需要“任意凡木”+凝胶=火把
而不是把所有木头都设定一个配方，就是木头 A+凝胶=火把，木头 B+凝胶=火把，木头 C+凝胶=火把…………
坏处是分类维度又变成了另一种可能需要分类的东西
分类维度应该基于玩家背包里有的物品来展示，分类时没有的物品就不展示分类维度了
还有个问题是分类不均，有些分类里的物品数量多，有些分类里物品数量少
这个不均应该不是大问题

分类维度应该基于玩家背包里有的物品来展示，分类时没有的物品就不展示分类维度了
这个会带来一个新问题
假如玩家只有一把剑，那背包里的分类维度就是

武器装备
--全部
--剑
消耗品
--全部
材料
--全部

这把剑装备之后，玩家身上就没有了，分类维度就会少了剑这个小分支
如果玩家当前就展示在剑分类上，此时应该换到武器装备分支的全部分支下
问题出在担心物品频繁增加删除时的分类界面变化，应该只是程序难写

目前开发的小类

'ordinary_wood';'凡木';
'spirit_wood';'灵木';
'spirit_grass';'灵草';
'ordinary_mushroom';'普通蘑菇';
'rare_mushroom';'稀有蘑菇';
'aquatic';'水产';
'fur';'毛皮';
'leather';'皮革';
'bone';'骨头';
'raw_meat';'生肉';
'rock';'岩石';
'ordinary_coin';'凡间钱币';
'wood_parts';'木制零件';
'iron_parts';'铁质零件';

## 任务剧情分支

游戏目前对于事件或者任务的设计是这样的

地点内有 n 个事件->
事件有自己的出现条件->
事件完成得到“某某事件完成”游戏状态标记

当玩家到地点时，根据玩家的各种游戏状态标记，决定地点内的 n 个事件出现哪些
安排好多个事件的出现条件，就可以做到分支

比如玩家解锁钓鱼技能，原定设计是拜访了村外老妇，接到了“学习钓鱼”支线任务，然后去木工坊买鱼竿找老板询问，完成支线得到任务奖励，任务奖励是解锁钓鱼

其中找老板询问如何钓鱼这一步，是根据玩家此时没解锁钓鱼的前提来设计的，由此设计老板说的话
如果以后开发了其他功能，钓鱼可以有其他方式解锁，那么这条线就出现 bug 了
所以应该设计一些分支，处理玩家游戏状态的其他情况

老妇人地点有“学习钓鱼”支线任务，也有“去某地钓鱼”支线任务
“学习钓鱼”支线任务的出现条件是玩家没学会钓鱼
“去某地钓鱼”支线任务的出现条件是玩家学会了钓鱼
这样从源头就做了分支，玩家有无解锁钓鱼，就可以走各自的路线

## 同 id 不同属性的物品的数据结构

目前的物品，有两种数据结构
一个是普通物品
class Player_Item {
constructor(id) {
this.id = id; //唯一 id
this.num = 0; //玩家拥有该物品总数
}
}
一个是装备
class Player_Item_E {
constructor(id) {
this.id = id; //唯一 id
this.num = 0; //玩家拥有该物品总数
this.rarity_num = new Object(); //稀有度
}
}

由于装备存在稀有度设定，在涉及到装备的物品的逻辑时都要单独写一块逻辑来处理
比如数量，就得根据每种稀有度遍历来获取
目前来说，稀有度比较固定，就那么几种，所以写起来虽然麻烦一点，但是还算可用
但是后续会有烹饪食品系统，同 id 的某种烹饪成品，可能因为烹饪过程添加的物品不同，最终有不同的属性
它们都是同 id 的物品，也涉及到像装备这样需要额外处理的情况

有没有比较好的解决方案呢

方案 1
用 id+属性的方式构建 id，确保不同属性的物品就是不同的 id
只在物品实例的部分用这个复合 id，数据库里不需要改

方案 2
保持原本方法

没想到其他方案，

## 玩家控制界面的按钮补充图案

目前在控制界面会有多种按钮
比如前往新地点
比如进入战斗区域
比如到 npc 面前

有时候这些按钮会一起出现，虽然在程序内部有做排序，同类型的按钮会放在一起，并且有前缀词语区分，但是感觉区分度还是不高
想要去某个地点时经常走错
所以打算在按钮前放一个图标，希望能比较意象的表达这个按钮的大体功能

比如
npc 地点有条件出现的事件用 ❔ 表示，就像其他游戏里的支线任务一样的
移动到其他地点的按钮用 🏃 表示
移动到 npc 地点 🙂
商店 🏪

有点抽象说实话，有些图标应该是可以实现这个效果的，而且很合适
但是有些图标实在难找，
要给每个按钮都安排一个图标，如果按照大功能通用，有些按钮上的图标应该会很怪
如果针对所有按钮单独设计图标，有些图标又找不到，而且风格很不统一

## 主菜单

这个功能

## select 下拉框

原生 select 下拉框什么都好，就是有个问题，下拉框内要出现 20 个选项才能出现滚动条，此时这个框就很长很长
关于这一点，没有找到简单的解决方法
截止 2025-12-17，V0.1.51 版本，这个问题倒不是很大的问题，先凑合用了

在这里记录一下优化方案

1：最理想最简单的解决方案：在 css 里加点什么我不知道的选项
ai 说加上  
max-height: 50px;
overflow-y: auto;
就好了，结果怎么试都没有生效
反正我觉得理论上应该有这个功能的，但是没有找到

2：使用文本框+select 组合
select 如果和设置 id、classname、value 这些属性一样设置了 size
这个组件就会从传统的点击后展开下拉框，变成类似列表的展开模式
这个展开模式实际上就是我想要的指定高度的下拉框，但是它是默认展开的
将它和一个文本框组合在一起使用，就能勉强凑出想要的功能

理论操作代码
https://mybj123.com/1326.html

原理是文本框下面放下拉框，下拉框设置 size 并且隐藏
点击文本框时，触发函数，把下拉框显示出来，模拟原生下拉框的显示出下拉选项的功能
点击了下拉框内的选项之后，触发函数，修改文本框的内容，并且把自己隐藏，模拟原生下拉框的选择选项的功能
点击了除下拉框内的其他的地方后，也隐藏下拉框，模拟原生下拉框点击其他地方取消选择的功能

有个新的问题就是，常态展示的文本框不像下拉框
毕竟下拉框右侧有个箭头，这个箭头是下拉框的特色，缺了总感觉少了什么
不过可以用伪元素画一个箭头出来，总体来说应该不算很复杂

3：根据点击行为设置 select 的 size
虽然设置了 select 的 size 后多选框就变成了新模式，但是如果是在点击了下拉框之后变成新模式，就还是符合需求的

 <!DOCTYPE html>
<html>
    <body>
        <select style="width: 100px" onmousedown="if(this.options.length>3){this.size=4}" onblur="this.size=1" onchange="this.size=1">
            <option value="volvo">Volvo</option>
            <option value="saab">Saab</option>
            <option value="opel">Opel</option>
            <option value="audi">Audi</option>
            <option value="audi2">Audi2</option>
            <option value="audi3">Audi3</option>
            <option value="audi4">Audi4</option>
            <option value="audi5">Audi5</option>
        </select>
    </body>
</html>

这是一个样例，不过它有个缺陷，是只能点击下拉框右侧的向下箭头才能触发 onmousedown，才能展开
理论上应该也可以简单改几行就行的，但是 ai 没有搞好，总是改的很复杂，而且效果还不如这个
